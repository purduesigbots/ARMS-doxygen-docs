<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARMS: Odometry Explanation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ARMS
   &#160;<span id="projectnumber">3.1.1</span>
   </div>
   <div id="projectbrief">Documentation for ARMS movement library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('odometry.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Odometry Explanation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The ARMS implementation of odometry follows the <a href="http://thepilons.ca/wp-content/uploads/2018/10/Tracking.pdf">PiLons odometry algorithm</a>, with a couple of modifications. </p>
<h1><a class="anchor" id="odometry_steps"></a>
Odometry Steps</h1>
<h2><a class="anchor" id="step_1"></a>
Step 1: Calculate Encoder Deltas</h2>
<p>Calculate how far each tracking wheel has moved since the previous update. </p><div class="fragment"><div class="line"><span class="comment">// get positions of each encoder</span></div>
<div class="line"><span class="keywordtype">double</span> left_pos = <a class="code" href="namespacearms_1_1odom.html#ac53d1bf493971017901340fc0a79e27a">getLeftEncoder</a>();</div>
<div class="line"><span class="keywordtype">double</span> right_pos = <a class="code" href="namespacearms_1_1odom.html#a0186e976d3e278164d2ab84e58c391da">getRightEncoder</a>();</div>
<div class="line"><span class="keywordtype">double</span> middle_pos = configData.middleEncoderPort ? <a class="code" href="namespacearms_1_1odom.html#af8aa553428d28217b5f24ec302aa0db3">getMiddleEncoder</a>() : 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// calculate change in each encoder</span></div>
<div class="line"><span class="keywordtype">double</span> delta_left = (left_pos - prev_left_pos) / tpi;</div>
<div class="line"><span class="keywordtype">double</span> delta_right = (right_pos - prev_right_pos) / tpi;</div>
<div class="line"><span class="keywordtype">double</span> delta_middle = configData.middleEncoderPort</div>
<div class="line">                        ? (middle_pos - prev_middle_pos) / middle_tpi</div>
<div class="line">                        : 0;</div>
<div class="ttc" id="anamespacearms_1_1odom_html_a0186e976d3e278164d2ab84e58c391da"><div class="ttname"><a href="namespacearms_1_1odom.html#a0186e976d3e278164d2ab84e58c391da">arms::odom::getRightEncoder</a></div><div class="ttdeci">double getRightEncoder()</div></div>
<div class="ttc" id="anamespacearms_1_1odom_html_ac53d1bf493971017901340fc0a79e27a"><div class="ttname"><a href="namespacearms_1_1odom.html#ac53d1bf493971017901340fc0a79e27a">arms::odom::getLeftEncoder</a></div><div class="ttdeci">double getLeftEncoder()</div></div>
<div class="ttc" id="anamespacearms_1_1odom_html_af8aa553428d28217b5f24ec302aa0db3"><div class="ttname"><a href="namespacearms_1_1odom.html#af8aa553428d28217b5f24ec302aa0db3">arms::odom::getMiddleEncoder</a></div><div class="ttdeci">double getMiddleEncoder()</div></div>
</div><!-- fragment --> <h2><a class="anchor" id="step_2"></a>
Step 2: Calculate Change in Heading and Current Heading</h2>
<p>If using an IMU, the current heading is obtained from the IMU, and the change in heading is calculated as the difference between the current and previous headings. If not using an IMU, the change in heading is calculated based on the change in position of the left and right tracking wheels, and the current heading is calculated as the sum of the previous heading with the change in heading. </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> delta_angle;</div>
<div class="line"><span class="keywordflow">if</span> (imu) {</div>
<div class="line">    heading = -<a class="code" href="namespacearms_1_1odom.html#a3e5678e1cce9e4d0f61f9052609631a2">imu</a>-&gt;get_rotation() * M_PI / 180.0;</div>
<div class="line">    delta_angle = heading - prev_heading;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    delta_angle = (delta_right - delta_left) / track_width;</div>
<div class="line"> </div>
<div class="line">    heading += delta_angle;</div>
<div class="line">}</div>
<div class="ttc" id="anamespacearms_1_1odom_html_a3e5678e1cce9e4d0f61f9052609631a2"><div class="ttname"><a href="namespacearms_1_1odom.html#a3e5678e1cce9e4d0f61f9052609631a2">arms::odom::imu</a></div><div class="ttdeci">std::shared_ptr&lt; pros::Imu &gt; imu</div></div>
</div><!-- fragment --> <h2><a class="anchor" id="step_3"></a>
Step 3: Store Previous Positions</h2>
<p>The current encoder positions and heading are stored as the previous encoder positions and heading for the next update. </p><div class="fragment"><div class="line">prev_left_pos = left_pos;</div>
<div class="line">prev_right_pos = right_pos;</div>
<div class="line">prev_middle_pos = middle_pos;</div>
<div class="line">prev_heading = heading;</div>
</div><!-- fragment --> <h2><a class="anchor" id="step_4"></a>
Step 4: Calculate Local Displacement</h2>
<p>Calculate the change in the robot's position from the previous step in local coordinates.</p>
<p>Note: The ARMS equations are slightly different from the PiLons equations due to ARMS using counterclockwise rotation as positive while PiLons uses clockwise rotation as positive. </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> local_x;</div>
<div class="line"><span class="keywordtype">double</span> local_y;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (delta_angle) {</div>
<div class="line">    <span class="keywordtype">double</span> i = sin(delta_angle / 2.0) * 2.0;</div>
<div class="line">    local_x = (delta_right / delta_angle - left_right_distance) * i;</div>
<div class="line">    local_y = (delta_middle / delta_angle + middle_distance) * i;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    local_x = delta_right;</div>
<div class="line">    local_y = delta_middle;</div>
<div class="line">}</div>
</div><!-- fragment --> <h2><a class="anchor" id="step_5"></a>
Step 5: Convert Local Displacement to Absolute Displacement and Add to Previous Position</h2>
<p>After this step is complete, we now have the robot's current x and y position as well as its heading. </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> p = heading - delta_angle / 2.0; <span class="comment">// global angle</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert to absolute displacement</span></div>
<div class="line">position.x += cos(p) * local_x - sin(p) * local_y;</div>
<div class="line">position.y += cos(p) * local_y + sin(p) * local_x;</div>
</div><!-- fragment --> <h2><a class="anchor" id="step_6"></a>
Step 6: Repeat Above Steps</h2>
<p>After a 10 millisecond delay to let the sensors update, we repeat the above steps. </p>
<h1><a class="anchor" id="odometry_code"></a>
Odometry Code</h1>
<div class="fragment"><div class="line"><span class="comment">// odom position values</span></div>
<div class="line">Point position;</div>
<div class="line"><span class="keywordtype">double</span> heading;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// previous values</span></div>
<div class="line"><span class="keywordtype">double</span> prev_left_pos = 0;</div>
<div class="line"><span class="keywordtype">double</span> prev_right_pos = 0;</div>
<div class="line"><span class="keywordtype">double</span> prev_middle_pos = 0;</div>
<div class="line"><span class="keywordtype">double</span> prev_heading = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> odomTask() {</div>
<div class="line"> </div>
<div class="line">    position.x = 0;</div>
<div class="line">    position.y = 0;</div>
<div class="line">    heading = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="comment">// get positions of each encoder</span></div>
<div class="line">        <span class="keywordtype">double</span> left_pos = <a class="code" href="namespacearms_1_1odom.html#ac53d1bf493971017901340fc0a79e27a">getLeftEncoder</a>();</div>
<div class="line">        <span class="keywordtype">double</span> right_pos = <a class="code" href="namespacearms_1_1odom.html#a0186e976d3e278164d2ab84e58c391da">getRightEncoder</a>();</div>
<div class="line">        <span class="keywordtype">double</span> middle_pos = configData.middleEncoderPort ? <a class="code" href="namespacearms_1_1odom.html#af8aa553428d28217b5f24ec302aa0db3">getMiddleEncoder</a>() : 0;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// calculate change in each encoder</span></div>
<div class="line">        <span class="keywordtype">double</span> delta_left = (left_pos - prev_left_pos) / tpi;</div>
<div class="line">        <span class="keywordtype">double</span> delta_right = (right_pos - prev_right_pos) / tpi;</div>
<div class="line">        <span class="keywordtype">double</span> delta_middle = configData.middleEncoderPort</div>
<div class="line">                                ? (middle_pos - prev_middle_pos) / middle_tpi</div>
<div class="line">                                : 0;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// calculate new heading</span></div>
<div class="line">        <span class="keywordtype">double</span> delta_angle;</div>
<div class="line">        <span class="keywordflow">if</span> (imu) {</div>
<div class="line">            heading = -<a class="code" href="namespacearms_1_1odom.html#a3e5678e1cce9e4d0f61f9052609631a2">imu</a>-&gt;get_rotation() * M_PI / 180.0;</div>
<div class="line">            delta_angle = heading - prev_heading;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            delta_angle = (delta_right - delta_left) / track_width;</div>
<div class="line"> </div>
<div class="line">            heading += delta_angle;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// store previous positions</span></div>
<div class="line">        prev_left_pos = left_pos;</div>
<div class="line">        prev_right_pos = right_pos;</div>
<div class="line">        prev_middle_pos = middle_pos;</div>
<div class="line">        prev_heading = heading;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// calculate local displacement</span></div>
<div class="line">        <span class="keywordtype">double</span> local_x;</div>
<div class="line">        <span class="keywordtype">double</span> local_y;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (delta_angle) {</div>
<div class="line">            <span class="keywordtype">double</span> i = sin(delta_angle / 2.0) * 2.0;</div>
<div class="line">            local_x = (delta_right / delta_angle - left_right_distance) * i;</div>
<div class="line">            local_y = (delta_middle / delta_angle + middle_distance) * i;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            local_x = delta_right;</div>
<div class="line">            local_y = delta_middle;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> p = heading - delta_angle / 2.0; <span class="comment">// global angle</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// convert to absolute displacement</span></div>
<div class="line">        position.x += cos(p) * local_x - sin(p) * local_y;</div>
<div class="line">        position.y += cos(p) * local_y + sin(p) * local_x;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (debug)</div>
<div class="line">            printf(<span class="stringliteral">&quot;%.2f, %.2f, %.2f \n&quot;</span>, position.x, position.y, <a class="code" href="namespacearms_1_1odom.html#a3c93c929fa68dd28cd6f11b2d30a2e7f">getHeading</a>());</div>
<div class="line"> </div>
<div class="line">        pros::delay(10);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="anamespacearms_1_1odom_html_a3c93c929fa68dd28cd6f11b2d30a2e7f"><div class="ttname"><a href="namespacearms_1_1odom.html#a3c93c929fa68dd28cd6f11b2d30a2e7f">arms::odom::getHeading</a></div><div class="ttdeci">double getHeading(bool radians=false)</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
